<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AskHippocrates â€“ Medizinethik im Geiste des Hippokrates</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --parchment:    #f5f0e8;
      --parchment-dk: #e8e0d0;
      --ink:          #2c2418;
      --ink-soft:     #5a4e3c;
      --olive:        #6b7c56;
      --olive-dark:   #4a5a3a;
      --olive-light:  #8fa474;
      --terracotta:   #b8704a;
      --gold:         #c9a84c;
      --gold-dim:     #a6893e;
      --marble:       #eae6de;
      --shadow:       rgba(44, 36, 24, 0.12);
    }

    html { font-size: 16px; }

    body {
      font-family: 'Lora', Georgia, serif;
      background: var(--parchment);
      color: var(--ink);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      /* subtle parchment texture via CSS */
      background-image:
        radial-gradient(ellipse at 20% 50%, rgba(200,180,140,0.15) 0%, transparent 70%),
        radial-gradient(ellipse at 80% 20%, rgba(180,160,120,0.1) 0%, transparent 60%),
        url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    }

    /* â”€â”€ Greek key border (top) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .greek-border {
      height: 12px;
      background: var(--olive-dark);
      position: relative;
      overflow: hidden;
    }
    .greek-border::after {
      content: '';
      position: absolute;
      inset: 2px 0;
      background: repeating-linear-gradient(
        90deg,
        var(--gold) 0px, var(--gold) 6px,
        var(--olive-dark) 6px, var(--olive-dark) 8px,
        var(--gold) 8px, var(--gold) 14px,
        transparent 14px, transparent 20px
      );
      opacity: 0.7;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      text-align: center;
      padding: 2rem 1.5rem 1.5rem;
      position: relative;
    }

    .caduceus {
      font-size: 2.4rem;
      display: block;
      margin-bottom: 0.5rem;
      animation: fadeDown 0.8s ease-out;
    }

    header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-weight: 700;
      font-size: clamp(1.6rem, 4vw, 2.4rem);
      color: var(--olive-dark);
      letter-spacing: 0.04em;
      animation: fadeDown 0.8s ease-out 0.1s both;
    }

    header p {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-style: italic;
      font-size: clamp(0.9rem, 2.2vw, 1.1rem);
      color: var(--ink-soft);
      margin-top: 0.35rem;
      animation: fadeDown 0.8s ease-out 0.25s both;
    }

    .divider {
      width: 60px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      margin: 1rem auto 0;
      animation: fadeDown 0.8s ease-out 0.35s both;
    }

    /* â”€â”€ Chat area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 740px;
      width: 100%;
      margin: 0 auto;
      padding: 0 1rem;
      overflow: hidden;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
    }

    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--parchment-dk); border-radius: 3px; }

    /* â”€â”€ Message bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .msg {
      max-width: 85%;
      padding: 1rem 1.25rem;
      border-radius: 1rem;
      line-height: 1.65;
      font-size: 0.95rem;
      animation: msgAppear 0.4s ease-out;
      position: relative;
    }

    .msg.user {
      align-self: flex-end;
      background: var(--olive);
      color: #f5f2ec;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(107,124,86,0.25);
    }

    .msg.assistant {
      align-self: flex-start;
      background: var(--marble);
      color: var(--ink);
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(107,124,86,0.12);
      box-shadow: 0 2px 10px var(--shadow);
    }

    .msg.assistant::before {
      content: 'âš•ï¸';
      position: absolute;
      top: -10px;
      left: 12px;
      font-size: 0.85rem;
      background: var(--parchment);
      padding: 0 4px;
      border-radius: 50%;
    }

    /* â”€â”€ Speech toggle & button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .speech-toggle {
      position: absolute;
      top: 1.2rem;
      right: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'Lora', Georgia, serif;
      font-size: 0.78rem;
      color: var(--ink-soft);
      animation: fadeDown 0.8s ease-out 0.4s both;
    }

    .speech-toggle button {
      background: none;
      border: 1.5px solid var(--olive-light);
      border-radius: 2rem;
      padding: 0.3rem 0.7rem;
      font-size: 0.82rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--olive-dark);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .speech-toggle button.active {
      background: var(--olive);
      color: #f5f2ec;
      border-color: var(--olive);
    }

    .speech-toggle button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(107,124,86,0.25);
    }

    .speak-btn {
      position: absolute;
      bottom: 6px;
      right: 8px;
      background: none;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      opacity: 0.4;
      transition: opacity 0.2s, transform 0.2s;
      padding: 2px 4px;
      border-radius: 4px;
    }

    .speak-btn:hover { opacity: 0.9; transform: scale(1.15); }
    .speak-btn.speaking { opacity: 1; animation: pulse 1s ease-in-out infinite; }

    /* â”€â”€ Welcome card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .welcome {
      text-align: center;
      padding: 2.5rem 1.5rem;
      animation: fadeDown 0.7s ease-out 0.5s both;
    }

    .welcome .quote {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-style: italic;
      font-size: 1.15rem;
      color: var(--ink-soft);
      max-width: 480px;
      margin: 0 auto 1.5rem;
      line-height: 1.6;
    }

    .welcome .quote em {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--olive);
      font-style: normal;
      letter-spacing: 0.05em;
    }

    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }

    .suggestions button {
      font-family: 'Lora', Georgia, serif;
      font-size: 0.82rem;
      padding: 0.55rem 1rem;
      background: transparent;
      color: var(--olive-dark);
      border: 1.5px solid var(--olive-light);
      border-radius: 2rem;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .suggestions button:hover {
      background: var(--olive);
      color: #f5f2ec;
      border-color: var(--olive);
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(107,124,86,0.3);
    }

    /* â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .typing {
      align-self: flex-start;
      display: none;
      gap: 5px;
      padding: 1rem 1.4rem;
      background: var(--marble);
      border-radius: 1rem;
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(107,124,86,0.12);
    }
    .typing.visible { display: flex; }

    .typing span {
      width: 7px;
      height: 7px;
      background: var(--olive-light);
      border-radius: 50%;
      animation: pulse 1.4s ease-in-out infinite;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    /* â”€â”€ Input bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-bar {
      padding: 1rem 0 1.5rem;
      display: flex;
      gap: 0.65rem;
      align-items: flex-end;
    }

    .input-bar textarea {
      flex: 1;
      font-family: 'Lora', Georgia, serif;
      font-size: 0.95rem;
      color: var(--ink);
      background: var(--marble);
      border: 1.5px solid var(--parchment-dk);
      border-radius: 1rem;
      padding: 0.8rem 1.1rem;
      resize: none;
      min-height: 48px;
      max-height: 140px;
      line-height: 1.5;
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }

    .input-bar textarea:focus {
      border-color: var(--olive-light);
      box-shadow: 0 0 0 3px rgba(107,124,86,0.12);
    }

    .input-bar textarea::placeholder {
      color: var(--ink-soft);
      opacity: 0.5;
      font-style: italic;
    }

    .send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: var(--olive);
      color: #f5f2ec;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
      background: var(--olive-dark);
      transform: scale(1.06);
      box-shadow: 0 3px 12px rgba(74,90,58,0.35);
    }

    .send-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center;
      padding: 0.6rem 1rem 1rem;
      font-size: 0.72rem;
      color: var(--ink-soft);
      opacity: 0.6;
      font-style: italic;
    }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes msgAppear {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 80%, 100% { transform: scale(0.7); opacity: 0.4; }
      40%           { transform: scale(1);   opacity: 1; }
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 600px) {
      header { padding: 1.4rem 1rem 1rem; }
      .msg { max-width: 92%; font-size: 0.9rem; }
      .welcome { padding: 1.5rem 1rem; }
      .suggestions { gap: 0.4rem; }
      .suggestions button { font-size: 0.78rem; padding: 0.45rem 0.8rem; }
    }
  </style>
</head>
<body>

  <div class="greek-border"></div>

  <header>
    <span class="caduceus">ğŸ›ï¸</span>
    <h1>AskHippocrates</h1>
    <p>Medizinethik im Geiste des Hippokrates</p>
    <div class="divider"></div>
    <div class="speech-toggle">
      <button id="autoSpeakBtn" class="active" onclick="toggleAutoSpeak()" title="Automatische Sprachausgabe">
        ğŸ”Š Stimme an
      </button>
    </div>
  </header>

  <div class="chat-wrapper">
    <div class="messages" id="messages">

      <div class="welcome" id="welcome">
        <div class="quote">
          Â»Erstens: nicht schaden. Die Heilkunst hat drei Grundlagen:
          die Krankheit, den Kranken und den Arzt.Â«
          <em>â€” Hippokrates von Kos</em>
        </div>
        <div class="suggestions">
          <button onclick="askSuggestion(this)">Was sagt der Eid zur Sterbehilfe?</button>
          <button onclick="askSuggestion(this)">KI in der Diagnostik â€“ ethisch vertretbar?</button>
          <button onclick="askSuggestion(this)">Darf ein Arzt die Behandlung verweigern?</button>
          <button onclick="askSuggestion(this)">Organspende: Widerspruchs- oder ZustimmungslÃ¶sung?</button>
        </div>
      </div>

      <div class="typing" id="typing">
        <span></span><span></span><span></span>
      </div>
    </div>

    <div class="input-bar">
      <textarea
        id="userInput"
        rows="1"
        placeholder="Stelle eine Frage zur Medizinethik â€¦"
        autofocus
      ></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Senden">
        â¤
      </button>
    </div>
  </div>

  <footer>
    Kein medizinischer Rat Â· Nur ethische Reflexion Â· Vibe Coding by Mr. Maniac
  </footer>

  <script>
    const messagesEl  = document.getElementById('messages');
    const typingEl    = document.getElementById('typing');
    const welcomeEl   = document.getElementById('welcome');
    const inputEl     = document.getElementById('userInput');
    const sendBtn     = document.getElementById('sendBtn');

    let conversationHistory = [];
    let isLoading = false;
    let autoSpeak = true;
    let currentAudio = null;

    // â”€â”€ Modern TTS (OpenAI via Server) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function speak(text, btn) {
      // Stop current playback
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        document.querySelectorAll('.speak-btn').forEach(b => b.classList.remove('speaking'));
        // If same button clicked while playing â†’ just stop
        if (btn && btn.classList.contains('speaking')) {
          btn.classList.remove('speaking');
          return;
        }
      }

      if (btn) btn.classList.add('speaking');

      try {
        const res = await fetch('/api/speak', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text }),
        });

        if (!res.ok) throw new Error('TTS failed');

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        currentAudio = new Audio(url);

        currentAudio.onended = () => {
          if (btn) btn.classList.remove('speaking');
          currentAudio = null;
          URL.revokeObjectURL(url);
        };
        currentAudio.onerror = () => {
          if (btn) btn.classList.remove('speaking');
          currentAudio = null;
        };

        await currentAudio.play();
      } catch (err) {
        console.error('TTS error:', err);
        if (btn) btn.classList.remove('speaking');
      }
    }

    function toggleAutoSpeak() {
      autoSpeak = !autoSpeak;
      const btn = document.getElementById('autoSpeakBtn');
      if (autoSpeak) {
        btn.textContent = 'ğŸ”Š Stimme an';
        btn.classList.add('active');
      } else {
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        document.querySelectorAll('.speak-btn').forEach(b => b.classList.remove('speaking'));
        btn.textContent = 'ğŸ”‡ Stimme aus';
        btn.classList.remove('active');
      }
    }

    // â”€â”€ Auto-resize textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 140) + 'px';
    });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // â”€â”€ Suggested questions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function askSuggestion(btn) {
      inputEl.value = btn.textContent;
      sendMessage();
    }

    // â”€â”€ Render a message bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addBubble(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = text;

      // Add speak button to assistant messages
      if (role === 'assistant') {
        div.style.position = 'relative';
        div.style.paddingBottom = '1.6rem';
        const speakBtn = document.createElement('button');
        speakBtn.className = 'speak-btn';
        speakBtn.textContent = 'ğŸ”Š';
        speakBtn.title = 'Vorlesen';
        speakBtn.onclick = () => speak(text, speakBtn);
        div.appendChild(speakBtn);
      }

      messagesEl.insertBefore(div, typingEl);
      scrollToBottom();

      // Auto-speak if enabled
      if (role === 'assistant' && autoSpeak) {
        speak(text, div.querySelector('.speak-btn'));
      }
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    // â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text || isLoading) return;

      // Hide welcome on first message
      if (welcomeEl) welcomeEl.remove();

      isLoading = true;
      sendBtn.disabled = true;
      inputEl.value = '';
      inputEl.style.height = 'auto';

      addBubble('user', text);
      conversationHistory.push({ role: 'user', content: text });

      typingEl.classList.add('visible');
      scrollToBottom();

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: conversationHistory }),
        });

        const data = await res.json();

        if (data.error) throw new Error(data.error);

        conversationHistory.push({ role: 'assistant', content: data.reply });
        addBubble('assistant', data.reply);
      } catch (err) {
        addBubble('assistant', 'Verzeih, mein Freund â€“ ein Fehler ist aufgetreten. Versuche es erneut.');
        console.error(err);
      } finally {
        typingEl.classList.remove('visible');
        isLoading = false;
        sendBtn.disabled = false;
        inputEl.focus();
      }
    }
  </script>

</body>
</html>
